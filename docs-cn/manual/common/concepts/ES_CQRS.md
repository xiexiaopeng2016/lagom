# 管理数据持久性

在设计微服务时，请记住，每个服务应拥有其数据并可以直接访问数据库。其他服务应随后使用服务API与数据进行交互。不得在不同服务之间共享数据库，因为这将导致服务之间的耦合过于紧密。这样，每个微服务都在清晰的边界内运行，类似于域驱动设计中的[边界上下文](https://martinfowler.com/bliki/BoundedContext.html)战略模式。

为了实现这种分离的架构，Lagom的持久性模块促进了[事件源](https://msdn.microsoft.com/en-us/library/jj591559.aspx)和[CQRS](https://msdn.microsoft.com/en-us/library/jj591573.aspx)的使用。事件源是将所有更改捕获为领域事件的实践，这是已经发生的事情的不变事实。例如，在使用ES的系统中，当Mike从他的银行帐户中提取资金时，该事件可以简单地存储为"提取100.00美元"，而不是在CRUD应用程序中进行复杂的交互操作，在该应用程序中，包装事务(wrapping transaction)提交之前，需要进行各种读取和更新操作。

事件源用于聚合根(Aggregate Root)，例如具有给定客户标识符的客户 --- Mike，在前面的示例中（有关更多详细信息，请参见[什么是聚合](http://cqrs.nu/Faq/aggregates)）。写入端在聚合中完全一致。这样就很容易推断出诸如维护不变性和验证传入命令之类的内容。采用此模型时，您需要注意的一个不同之处是，聚合可以回复对特定标识符的查询，但不能用于为跨越多个聚合的查询提供服务。因此，您需要创建针对该服务提供的查询量身定制的数据的另一个视图。

Lagom将事件流保留在数据库中。事件流处理器，其他服务或客户端读取已存储的事件并可以选择对其执行操作。Lagom支持[[持久性读取端处理器|ReadSide]]和[[消息代理主题订阅者|MessageBrokerApi]]。您还可以使用[[原始事件流|Re原始adSide]]来创建自己的事件流处理器。

如果您不想使用事件源和CQRS，则可能应该使用Lagom中的Persistence模块之外的其他功能。但是，我们建议您先阅读[[事件源的优势|ESAdvantage]]。你可能也想看看演示文稿[Lagom能为您做些什么?](https://www.reactivesummit.org/2018/schedule/what-can-lagom-do-for-you), 它大约有50分钟长，解释了使用Lagom持久性API的好处。

如果您选择不使用Lagom的持久性模块，那么Lagom持久性模块中的`CassandraSession`提供了一个异步API，用于在Cassandra中存储数据。但是，您可以使用任何数据存储解决方案来实现Lagom服务。如果您选择使用Lagom持久性模块之外的其他模块，请记住使用异步api来实现更好的可伸缩性。如果您正在使用阻塞api，比如JDBC或JPA，那么您应该为调用这些阻塞api的组件使用固定/有限大小的专用线程池来小心地管理阻塞。不要通过多个异步调用(如服务API调用)级联阻塞。
